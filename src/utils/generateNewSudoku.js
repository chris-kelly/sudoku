// GENERATE NEW SUDOKU GAME

import { matrix,index,subset,reshape,floor,random,transpose } from 'mathjs'
import { gRange,shuffleArray } from './mathHelperFunctions'
import { cleanup } from './hintHelperFunctions'

var sudokuSets = {
    'Easy': {
        1: {winner: 
            [[9, 2, 6, 8, 7, 1, 5, 3, 4],
             [8, 5, 1, 3, 4, 9, 6, 7, 2],
             [4, 7, 3, 2, 5, 6, 1, 8, 9],
             [6, 8, 5, 1, 3, 2, 9, 4, 7],
             [7, 3, 4, 5, 9, 8, 2, 1, 6],
             [2, 1, 9, 7, 6, 4, 8, 5, 3],
             [3, 4, 2, 9, 1, 5, 7, 6, 8],
             [5, 6, 8, 4, 2, 7, 3, 9, 1],
             [1, 9, 7, 6, 8, 3, 4, 2, 5]
            ],
            preFilled: 
            [[9,0,6,8,0,0,0,0,0],
             [0,5,0,0,4,9,6,0,2],
             [4,7,3,2,0,6,0,0,9],
             [0,0,0,1,3,2,9,0,7],
             [7,0,4,5,9,0,0,1,0],
             [0,0,9,0,0,0,0,0,0],
             [0,0,2,0,1,5,7,6,8],
             [5,6,0,0,0,7,3,0,1],
             [1,0,0,6,0,0,4,0,0],
            ],
        },
        2: {winner: 
            [[9, 2, 6, 3, 4, 5, 8, 7, 1],
             [8, 5, 1, 7, 2, 6, 3, 4, 9],
             [4, 7, 3, 8, 9, 1, 2, 5, 6],
             [2, 1, 9, 5, 3, 8, 7, 6, 4],
             [7, 3, 4, 1, 6, 2, 5, 9, 8],
             [6, 8, 5, 4, 7, 9, 1, 3, 2],
             [5, 6, 8, 9, 1, 3, 4, 2, 7],
             [1, 9, 7, 2, 5, 4, 6, 8, 3],
             [3, 4, 2, 6, 8, 7, 9, 1, 5]
            ],
            preFilled: 
            [[0,2,0,3,4,0,0,0,1],
             [8,5,0,0,2,0,0,4,0],
             [0,0,3,0,0,1,2,5,6],
             [0,0,0,0,3,0,7,6,0],
             [0,0,4,1,6,0,5,9,0],
             [6,8,0,4,0,0,0,0,0],
             [5,0,8,0,0,3,0,0,0],
             [1,9,7,2,5,4,0,0,0],
             [0,4,2,0,0,7,9,1,0],
            ], 
        },
        3: {winner: 
            [[1, 9, 7, 6, 8, 3, 2, 5, 4],
             [5, 6, 8, 4, 2, 7, 9, 1, 3],
             [3, 4, 2, 9, 1, 5, 6, 8, 7],
             [6, 8, 5, 1, 3, 2, 4, 7, 9],
             [7, 3, 4, 5, 9, 8, 1, 6, 2],
             [2, 1, 9, 7, 6, 4, 5, 3, 8],
             [8, 5, 1, 3, 4, 9, 7, 2, 6],
             [4, 7, 3, 2, 5, 6, 8, 9, 1],
             [9, 2, 6, 8, 7, 1, 3, 4, 5]
            ],
            preFilled: 
            [[0,0,0,6,8,3,0,5,0],
             [5,0,0,4,2,7,9,1,0],
             [0,4,2,0,0,0,0,0,0],
             [6,0,5,0,0,2,0,7,9],
             [0,3,0,0,9,0,1,6,0],
             [2,0,9,7,6,4,5,3,8],
             [0,0,0,0,0,0,7,0,0],
             [0,7,0,0,0,6,8,9,1],
             [0,2,6,8,0,0,0,0,0]
            ], 
        }   
    },
    'Medium': {
        1: {winner: 
            [[3, 7, 8, 4, 1, 5, 9, 6, 2],
             [4, 2, 9, 7, 6, 3, 1, 8, 5],
             [5, 6, 1, 9, 2, 8, 3, 7, 4],
             [9, 8, 4, 6, 7, 2, 5, 3, 1],
             [2, 5, 7, 8, 3, 1, 6, 4, 9],
             [6, 1, 3, 5, 4, 9, 8, 2, 7],
             [8, 3, 2, 1, 5, 7, 4, 9, 6],
             [7, 4, 5, 3, 9, 6, 2, 1, 8],
             [1, 9, 6, 2, 8, 4, 7, 5, 3]
            ],
            preFilled: 
            [[3,0,8,0,1,5,0,0,0],
             [4,0,9,7,0,0,0,0,5],
             [5,6,1,0,0,8,0,0,0],
             [9,0,4,0,0,0,5,3,0],
             [0,5,0,0,0,1,0,4,9],
             [0,0,0,0,0,0,8,0,0],
             [0,3,0,0,0,7,0,0,6],
             [7,0,0,3,9,0,2,0,0],
             [0,0,0,0,8,0,7,0,0]
            ],
        },
        2: {winner: 
            [[9, 7, 1, 6, 3, 8, 2, 5, 4],
             [6, 8, 5, 4, 7, 2, 9, 1, 3],
             [4, 2, 3, 9, 5, 1, 6, 8, 7],
             [7, 3, 4, 2, 6, 5, 8, 9, 1],
             [5, 1, 8, 3, 9, 4, 7, 2, 6],
             [2, 6, 9, 8, 1, 7, 3, 4, 5],
             [1, 9, 2, 7, 4, 6, 5, 3, 8],
             [3, 4, 7, 5, 8, 9, 1, 6, 2],
             [8, 5, 6, 1, 2, 3, 4, 7, 9]
            ],
            preFilled: 
            [[0,7,0,0,3,0,2,0,0],
             [0,0,5,0,0,2,9,0,0],
             [4,0,0,9,0,0,0,0,0],
             [0,0,4,2,0,5,0,9,0],
             [0,1,0,3,9,0,7,0,6],
             [2,0,0,0,0,0,0,0,5],
             [1,9,2,7,0,0,0,3,0],
             [0,4,7,5,0,0,1,0,0],
             [0,0,0,1,0,3,0,0,0],
            ],
        },
        3: {winner: 
            [[5, 6, 8, 9, 3, 1, 4, 2, 7],
             [3, 4, 2, 6, 7, 8, 9, 1, 5],
             [1, 9, 7, 2, 4, 5, 6, 8, 3],
             [9, 2, 6, 3, 5, 4, 8, 7, 1],
             [8, 5, 1, 7, 6, 2, 3, 4, 9],
             [4, 7, 3, 8, 1, 9, 2, 5, 6],
             [2, 1, 9, 5, 8, 3, 7, 6, 4],
             [7, 3, 4, 1, 2, 6, 5, 9, 8],
             [6, 8, 5, 4, 9, 7, 1, 3, 2]
            ],
            preFilled: 
            [[5,0,0,0,3,0,4,0,7],
             [3,0,2,6,0,0,9,0,0],
             [0,0,7,0,4,0,0,8,0],
             [0,2,6,0,0,0,8,0,1],
             [0,0,0,7,6,0,0,4,0],
             [4,7,0,0,0,0,2,0,0],
             [2,1,0,0,0,0,7,0,0],
             [0,0,4,0,0,6,5,0,0],
             [0,0,0,0,9,7,0,3,0]
           ], 
        }   
    },
    'Hard': {
        1: {winner: 
            [[9,8,2,1,4,5,7,3,6],
            [7,5,3,9,2,6,4,8,1],
            [6,4,1,8,7,3,2,5,9],
            [4,9,8,3,5,1,6,2,7],
            [2,1,7,6,8,4,5,9,3],
            [5,3,6,2,9,7,1,4,8],
            [8,6,5,4,1,9,3,7,2],
            [3,7,9,5,6,2,8,1,4],
            [1,2,4,7,3,8,9,6,5],
            ],
            preFilled: 
            [[0,0,0,0,4,0,0,3,6],
            [0,0,0,0,2,6,0,8,0],
            [0,0,1,0,0,0,0,0,0],
            [0,9,0,0,0,0,0,0,7],
            [0,0,0,6,8,4,5,0,0],
            [0,0,0,0,0,0,1,0,0],
            [8,6,5,0,0,0,0,0,0],
            [3,0,0,0,0,0,0,0,0],
            [1,0,0,7,0,8,9,0,0],
            ],
        },
        2: {winner: 
            [[1,5,4,8,9,6,3,2,7],
            [3,9,7,4,2,1,8,5,6],
            [8,2,6,7,5,3,1,4,9],
            [7,6,2,1,8,9,5,3,4],
            [9,8,5,6,3,4,7,1,2],
            [4,1,3,2,7,5,9,6,8],
            [2,7,1,3,4,8,6,9,5],
            [6,4,9,5,1,7,2,8,3],
            [5,3,8,9,6,2,4,7,1],
            ],
            preFilled: 
            [[1,0,0,0,0,0,0,2,0],
            [3,0,0,0,0,1,0,0,0],
            [0,2,0,7,0,0,0,4,0],
            [0,0,0,0,0,0,5,3,4],
            [9,0,0,6,0,0,7,0,0],
            [0,0,3,2,7,0,0,0,0],
            [0,0,1,3,0,8,6,0,5],
            [0,0,9,0,0,0,0,0,0],
            [5,3,8,0,0,0,0,0,0],
            ],
        },
        3: {winner: 
            [[8,1,9,2,4,7,3,6,5],
            [6,3,7,5,9,8,1,2,4],
            [2,4,5,3,6,1,8,7,9],
            [4,9,6,7,8,5,2,1,3],
            [1,7,2,6,3,9,4,5,8],
            [3,5,8,1,2,4,7,9,6],
            [5,2,3,4,1,6,9,8,7],
            [7,8,1,9,5,3,6,4,2],
            [9,6,4,8,7,2,5,3,1],
            ],
            preFilled: 
            [[0,1,9,2,0,0,0,0,0],
            [6,0,7,0,0,0,0,0,0],
            [0,0,0,0,6,1,0,0,0],
            [0,0,6,0,0,0,2,1,0],
            [0,0,0,0,3,0,4,0,0],
            [0,5,0,0,0,4,0,9,0],
            [0,0,3,0,0,0,0,8,0],
            [7,0,0,9,5,0,0,0,2],
            [9,6,0,0,7,0,0,0,0],
            ],
        }   
    }     
}

var constraints = [
    // rows
    [[0,0],[0,1],[0,2],[0,3],[0,4],[0,5],[0,6],[0,7],[0,8]],
    [[1,0],[1,1],[1,2],[1,3],[1,4],[1,5],[1,6],[1,7],[1,8]],
    [[2,0],[2,1],[2,2],[2,3],[2,4],[2,5],[2,6],[2,7],[2,8]],
    [[3,0],[3,1],[3,2],[3,3],[3,4],[3,5],[3,6],[3,7],[3,8]],
    [[4,0],[4,1],[4,2],[4,3],[4,4],[4,5],[4,6],[4,7],[4,8]],
    [[5,0],[5,1],[5,2],[5,3],[5,4],[5,5],[5,6],[5,7],[5,8]],
    [[6,0],[6,1],[6,2],[6,3],[6,4],[6,5],[6,6],[6,7],[6,8]],
    [[7,0],[7,1],[7,2],[7,3],[7,4],[7,5],[7,6],[7,7],[7,8]],
    [[8,0],[8,1],[8,2],[8,3],[8,4],[8,5],[8,6],[8,7],[8,8]],
    // columns
    [[0,0],[1,0],[2,0],[3,0],[4,0],[5,0],[6,0],[7,0],[8,0]],
    [[0,1],[1,1],[2,1],[3,1],[4,1],[5,1],[6,1],[7,1],[8,1]],
    [[0,2],[1,2],[2,2],[3,2],[4,2],[5,2],[6,2],[7,2],[8,2]],
    [[0,3],[1,3],[2,3],[3,3],[4,3],[5,3],[6,3],[7,3],[8,3]],
    [[0,4],[1,4],[2,4],[3,4],[4,4],[5,4],[6,4],[7,4],[8,4]],
    [[0,5],[1,5],[2,5],[3,5],[4,5],[5,5],[6,5],[7,5],[8,5]],
    [[0,6],[1,6],[2,6],[3,6],[4,6],[5,6],[6,6],[7,6],[8,6]],
    [[0,7],[1,7],[2,7],[3,7],[4,7],[5,7],[6,7],[7,7],[8,7]],
    [[0,8],[1,8],[2,8],[3,8],[4,8],[5,8],[6,8],[7,8],[8,8]],
    // boxes
    [[0,0],[0,1],[0,2],[1,0],[1,1],[1,2],[2,0],[2,1],[2,2]],
    [[3,0],[3,1],[3,2],[4,0],[4,1],[4,2],[5,0],[5,1],[5,2]],
    [[6,0],[6,1],[6,2],[7,0],[7,1],[7,2],[8,0],[8,1],[8,2]],
    [[0,3],[0,4],[0,5],[1,3],[1,4],[1,5],[2,3],[2,4],[2,5]],
    [[3,3],[3,4],[3,5],[4,3],[4,4],[4,5],[5,3],[5,4],[5,5]],
    [[6,3],[6,4],[6,5],[7,3],[7,4],[7,5],[8,3],[8,4],[8,5]],
    [[0,6],[0,7],[0,8],[1,6],[1,7],[1,8],[2,6],[2,7],[2,8]],
    [[3,6],[3,7],[3,8],[4,6],[4,7],[4,8],[5,6],[5,7],[5,8]],
    [[6,6],[6,7],[6,8],[7,6],[7,7],[7,8],[8,6],[8,7],[8,8]]
];

/**
 * Setup sudoku object from pre-filled sudoku numbers 
 * @param {object} preFilled - Array of pre-filled sudoku numbers. Missing cells recorded as a zero.
 */
const setupSudoku = function(preFilled) {
    // Create 3d matrix of zeros
    let sudoku = matrix(
        reshape(
            Array(9*9*10).fill(0),
            [9,9,10]
            )
        );
    // populate filled in result cells
    sudoku.subset(
        index(gRange(9),gRange(9),0),
        matrix(preFilled)
        );
    // populate potential numbers
    sudoku.subset(
        index(gRange(9),gRange(9),gRange(1,9)),
        reshape(Array(81).fill(gRange(1,9)),[9,9,9])
        );
    return({sudoku: sudoku})
};

/**
 * Setup sudoku object from pre-filled sudoku numbers 
 * @param {object} sudokuSets - Array of sets of prefilled/filled-in sudokus
 * @param {object} constraints - Array of constraints (e.g. row indicies, column indicies, box indicies) 
 */
const generateNewSudokuFromSeed = function(sudokuSets,constraints) {
    // choose random sudoku seed
    let sudoku_chosen = shuffleArray(Object.keys(sudokuSets))[0]
    let pref = sudokuSets[sudoku_chosen]['preFilled']
    let win = sudokuSets[sudoku_chosen]['winner']
    let r1 = shuffleArray([1,2,3]).map(x => shuffleArray([-1,-2,-3]).map(y => -4-y+x*3)).flat()
    if(random() < 0.5) {r1 = r1.reverse()}
    let r2 = shuffleArray([1,2,3]).map(x => shuffleArray([-1,-2,-3]).map(y => -4-y+x*3)).flat().reverse()
    if(random() < 0.5) {r2 = r2.reverse()}
    // shuffle boxes row-wise and within-box rows
    pref = subset(pref,index(r1,gRange(9)))
    win = subset(win,index(r1,gRange(9)))
    // shuffle boxes col-wise and within-box cols
    pref = subset(pref,index(gRange(9),r2))
    win = subset(win,index(gRange(9),r2))
    // switch all the numbers around
    let r3 = shuffleArray(gRange(1,9))
    pref = pref.map(row => row.map(x => x != 0 ? r3[x-1] : 0).flat())
    win = win.map(row => row.map(x => r3[x-1]).flat())
    if(random() < 0.5) {pref = transpose(pref); win = transpose(win)}
    let sudoku = cleanup(setupSudoku(pref),constraints)
    return({'preFilled': pref, 'winner': win, 'sudoku': sudoku, 'time': console.time})
}

export {
    sudokuSets as sudokuSets,     
    constraints as constraints,
    setupSudoku as setupSudoku,
    generateNewSudokuFromSeed as generateNewSudokuFromSeed,
}

